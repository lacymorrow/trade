{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">{{ bot.name }}</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            {% if bot.status == 'stopped' %}
            <button class="btn btn-success start-bot me-2" data-bot-id="{{ bot.id }}">
                <i class="fa fa-play"></i> Start Bot
            </button>
            {% else %}
            <button class="btn btn-danger stop-bot me-2" data-bot-id="{{ bot.id }}">
                <i class="fa fa-stop"></i> Stop Bot
            </button>
            {% endif %}
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#configModal">
                <i class="fa fa-cog"></i> Configure
            </button>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Bot Information</h5>
                    <div class="mb-3">
                        <strong>Status:</strong>
                        <span class="status-indicator status-{{ bot.status }}"></span>
                        {{ bot.status }}
                    </div>
                    <div class="mb-3">
                        <strong>Trading Symbols:</strong>
                        <div class="d-flex flex-wrap gap-1 mt-2">
                            {% for symbol in bot.get_symbols() %}
                            <span class="badge bg-light text-dark">{{ symbol }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>Created:</strong> {{ bot.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                    </div>
                    <div>
                        <strong>Last Updated:</strong> {{ bot.last_updated.strftime('%Y-%m-%d %H:%M:%S') }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Configuration</h5>
                    {% set config = bot.get_config() %}
                    <div class="mb-3">
                        <strong>Initial Capital:</strong> ${{ "%.2f"|format(config.initial_capital) }}
                    </div>
                    <div class="mb-3">
                        <strong>Risk per Trade:</strong> {{ "%.1f"|format(config.risk_per_trade * 100) }}%
                    </div>
                    <div class="mb-3">
                        <strong>Take Profit:</strong> {{ "%.1f"|format(config.take_profit * 100) }}%
                    </div>
                    <div class="mb-3">
                        <strong>Stop Loss:</strong> {{ "%.1f"|format(config.stop_loss * 100) }}%
                    </div>
                    <div class="mb-3">
                        <strong>Max Positions:</strong> {{ config.max_positions }}
                    </div>
                    <h6 class="mt-4">Strategy Parameters</h6>
                    <div class="mb-2">
                        <strong>Trend Weight:</strong> {{ "%.1f"|format(config.strategy_params.trend_weight * 100) }}%
                    </div>
                    <div class="mb-2">
                        <strong>Momentum Weight:</strong> {{ "%.1f"|format(config.strategy_params.momentum_weight * 100) }}%
                    </div>
                    <div>
                        <strong>Sentiment Weight:</strong> {{ "%.1f"|format(config.strategy_params.sentiment_weight * 100) }}%
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Recent Trades</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th>P/L</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in trades %}
                                <tr>
                                    <td>{{ trade.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ trade.symbol }}</td>
                                    <td>
                                        <span class="badge {% if trade.side == 'buy' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ trade.side }}
                                        </span>
                                    </td>
                                    <td>{{ "%.4f"|format(trade.quantity) }}</td>
                                    <td>${{ "%.2f"|format(trade.price) }}</td>
                                    <td>
                                        <span class="badge {% if trade.status == 'open' %}bg-primary{% elif trade.status == 'closed' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ trade.status }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if trade.pnl %}
                                        <span class="{% if trade.pnl > 0 %}text-success{% else %}text-danger{% endif %}">
                                            ${{ "%.2f"|format(trade.pnl) }}
                                        </span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">No trades yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Bot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="configForm">
                <div class="modal-body">
                    {% set config = bot.get_config() %}
                    <div class="mb-3">
                        <label class="form-label">Trading Symbols (comma-separated)</label>
                        <input type="text" class="form-control" name="symbols" value="{{ bot.get_symbols()|join(',') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Risk per Trade (%)</label>
                        <input type="number" class="form-control" name="risk_per_trade"
                               value="{{ "%.1f"|format(config.risk_per_trade * 100) }}" step="0.1" min="0.1" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Take Profit (%)</label>
                        <input type="number" class="form-control" name="take_profit"
                               value="{{ "%.1f"|format(config.take_profit * 100) }}" step="0.1" min="0.1" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stop Loss (%)</label>
                        <input type="number" class="form-control" name="stop_loss"
                               value="{{ "%.1f"|format(config.stop_loss * 100) }}" step="0.1" min="0.1" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Positions</label>
                        <input type="number" class="form-control" name="max_positions"
                               value="{{ config.max_positions }}" min="1" max="100">
                    </div>
                    <h6 class="mt-4">Strategy Parameters</h6>
                    <div class="mb-3">
                        <label class="form-label">Trend Weight (%)</label>
                        <input type="number" class="form-control" name="trend_weight"
                               value="{{ "%.1f"|format(config.strategy_params.trend_weight * 100) }}" step="0.1" min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Momentum Weight (%)</label>
                        <input type="number" class="form-control" name="momentum_weight"
                               value="{{ "%.1f"|format(config.strategy_params.momentum_weight * 100) }}" step="0.1" min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sentiment Weight (%)</label>
                        <input type="number" class="form-control" name="sentiment_weight"
                               value="{{ "%.1f"|format(config.strategy_params.sentiment_weight * 100) }}" step="0.1" min="0" max="100">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('.start-bot').click(function() {
        const botId = $(this).data('bot-id');
        const button = $(this);

        $.get(`/bot/${botId}/start`)
            .done(function(response) {
                location.reload();
            })
            .fail(function(xhr) {
                alert(xhr.responseJSON.error || 'Failed to start bot');
            });
    });

    $('.stop-bot').click(function() {
        const botId = $(this).data('bot-id');
        const button = $(this);

        $.get(`/bot/${botId}/stop`)
            .done(function(response) {
                location.reload();
            })
            .fail(function(xhr) {
                alert(xhr.responseJSON.error || 'Failed to stop bot');
            });
    });

    $('#configForm').submit(function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        $.ajax({
            url: '/bot/{{ bot.id }}/update',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                location.reload();
            },
            error: function(xhr) {
                alert(xhr.responseJSON.error || 'Failed to update configuration');
            }
        });
    });
});
</script>
{% endblock %}
